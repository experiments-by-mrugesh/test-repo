name: Test git-wt

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test-git-wt:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Set up Go 1.23
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Build and install git-wt
        run: |
          git clone https://github.com/raisedadead/git-wt.git /tmp/git-wt-src
          cd /tmp/git-wt-src
          mkdir -p $HOME/bin
          go build -o $HOME/bin/git-wt ./cmd/git-wt
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Create test config with hooks
        run: |
          mkdir -p $HOME/.config/git-wt
          cat > $HOME/.config/git-wt/config.toml << 'TOML'
          worktree_root = "/tmp/worktrees"

          [hooks]
          post_clone = ["touch /tmp/marker_post_clone"]
          post_add = ["touch /tmp/marker_post_add"]
          TOML
          cat $HOME/.config/git-wt/config.toml

      - name: Test clone command
        run: |
          git-wt clone https://github.com/${{ github.repository }} test-repo --timeout 300
          test -d /tmp/worktrees/test-repo/main || (echo "FAIL: clone did not create main worktree" && exit 1)
          test -f /tmp/marker_post_clone || (echo "FAIL: post_clone hook did not run" && exit 1)
          echo "PASS: clone command works"

      - name: Test add with branch flattening
        run: |
          cd /tmp/worktrees/test-repo
          git-wt add test/feature --new
          test -d /tmp/worktrees/test-repo/test-feature || (echo "FAIL: directory not flattened" && exit 1)
          cd test-feature && test "$(git branch --show-current)" = "test/feature" || (echo "FAIL: branch name wrong" && exit 1)
          test -f /tmp/marker_post_add || (echo "FAIL: post_add hook did not run" && exit 1)
          echo "PASS: add command works with flattening"

      - name: Test delete command
        run: |
          cd /tmp/worktrees/test-repo
          git-wt delete test/feature -y
          test ! -d /tmp/worktrees/test-repo/test-feature || (echo "FAIL: delete did not remove directory" && exit 1)
          echo "PASS: delete command works"

      - name: Test list command
        run: |
          cd /tmp/worktrees/test-repo
          git-wt list
          git-wt list --json | jq .
          echo "PASS: list command works"

      - name: Cleanup
        run: |
          rm -rf /tmp/worktrees /tmp/marker_*
          echo "PASS: All tests completed"
